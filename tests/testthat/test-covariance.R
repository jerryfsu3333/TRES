context("Covariance matrix")

test_that("Covariance matrix", {
  data("bat")
  fit_1d1 <- TRR.fit(bat$x, bat$y, u = c(14,14), method = "1D")
  expect_match(as.character(packageVersion("pracma")), "2.2.9")
  expect_equal(fit_1d1$En@data[1:5], c(-0.3103211653025588,0.0023601755880206,0.1206545544608466,0.0466319358504608,-0.0399073247958657), 1e-16)
  expect_equal(fit_1d1$S_list_1[[2]][1:5], c(0.3478901322168588,0.0030047743893053,-0.1173551495169119,-0.0902720882477163,0.0311771021830225), 1e-16)
  expect_equal(fit_1d1$S_list_2[[2]][1:5], c(0.1971643109159085,0.1148500669048811,0.0007595006601286,-0.0340736443790221,0.0473902674225449), 1e-16)
  expect_equal(unlist(fit_1d1$norm_list_1), c(0.0178143835325969,0.1466263945150640,0.6524689802166618,0.8832293126429576,0.9147714401429731,0.9190159129161337,0.9196388484420159,0.9197360981788927,0.9197519532184820), 1e-16)
  expect_equal(unlist(fit_1d1$norm_list_2), c(0.3362974615646127,0.6597702726692586,0.8789329849165151,0.9124554528296728,0.9172218909159867,0.9179497314646189,0.9180669776730489,0.9180865855220856), 1e-16)
  expect_equal(fit_1d1$Tsn_list_1[[1]]@data[1:5], c(-0.3103211653025588,0.0023601755880206,0.1206545544608466,0.0466319358504608,-0.0399073247958657), 1e-16)
  expect_equal(fit_1d1$Tsn_list_2[[1]]@data[1:5], c(-0.4292828827702051,0.0335687452391265,0.2892720404706690,-0.2996378022854722,-0.1857887209828823), 1e-16)
  expect_equal(fit_1d1$TsnTsn_list_1[[1]][1:5], c(0.0061974482425170,0.0000535282034000,-0.0020906096430195,-0.0016081416023333,0.0005554008557233), 1e-16)
  expect_equal(fit_1d1$TsnTsn_list_2[[1]][1:5], c(0.0663058572721561,0.0386237859606375,0.0002554181440579,-0.0114588801109205,0.0159372266370700), 1e-16)
  expect_equal(fit_1d1$Sinvhalf_list_1[[1]][1:5], c(38.9998541066681668,6.1298196896407173,-4.2727896795492164,11.5520712181481926,-17.6632249221978945), 1e-16)
  expect_equal(fit_1d1$Sinvhalf_list_2[[1]][1:5], c(13.6981177538128129,2.9713075769618946,2.1039975671290909,-18.9368326256073658,-9.2043591325106817), 1e-16)
  expect_equal(fit_1d1$Sigma[[1]][1:5], c(0.3575493270351964,0.0074535988641281,-0.1087156290990444,-0.0979391945980043,0.0390829818639938), 1e-16)
  expect_equal(fit_1d1$Sigma[[2]][6:10], c(0.0177810223877825,-0.0266821362173798,-0.0159772979718771,-0.0519756927006410,0.0018383691306572), 1e-16)
  expect_equal(fit_1d1$M_list[[1]][1:5], c(0.3288800611837778,0.0068559492778251,-0.0999985178162761,-0.0900861667920602,0.0359492033540018), 1e-16)
  expect_equal(fit_1d1$U_list[[1]][1:5], c(0.0233600851919101,0.0003683074612309,-0.0077124832475057,-0.0070067234516545,0.0022313086456458), 1e-16)
  expect_equal(fit_1d1$W0_list[[1]][[1]][1:5], c(0.0019916035851673,-0.0006808296771030,-0.0009928202065522,-0.0008029470156978,0.0000252780783541), 1e-16)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$nrmX, 1)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$f), -11.0112702876024411)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$g[1:5], c(6.5467815904918139,0.2391295768696464,-2.4984332588195102,-1.9312239505496627,0.6963569808495462), 1e-16)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$dtX)[1:5], c(-6.5388151761511644,-0.2418528955780516,2.4944619779933110,1.9280121624868793,-0.6962558685361299), 1e-16)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$nrmG, 12.0760727114176039, 1e-16)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$XDiff_list[[1]], 0.0003019015976517, 1e-16)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$FDiff_list[[1]]), 0.0015758104839648, 1e-16)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$Q_list[[1]], 1.8500000000000001, 1e-16)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$Cval_list[[1]]), -11.0215013609240291, 1e-16)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$X_list[[1]])[1:5], c(0.0006838366483016,-0.0007291981999533,-0.0004939256428093,-0.0004173428036331,-0.0001139729660080), 1e-16)
  expect_equal(fit_1d1$Gamma[[1]][1:5,1], c(0.00014302,-0.00068032,-0.00039628,-0.00031333,-0.00006079))
})

