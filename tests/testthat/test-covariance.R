context("Covariance matrix")

test_that("Covariance matrix", {
  data("bat")
  fit_1d1 <- TRR.fit(bat$x, bat$y, u = c(14,14), method = "1D")
  expect_equal(unname(unlist(.Machine)), c(0.0000000000000002,0.0000000000000001,0.0000000000000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.0000000000000000,2.0000000000000000,53.0000000000000000,5.0000000000000000,0.0000000000000000,-52.0000000000000000,-53.0000000000000000,11.0000000000000000,-1022.0000000000000000,1024.0000000000000000,2147483647.0000000000000000,8.0000000000000000,8.0000000000000000,16.0000000000000000,8.0000000000000000,0.0000000000000000,0.0000000000000000,64.0000000000000000,5.0000000000000000,0.0000000000000000,-63.0000000000000000,-64.0000000000000000,15.0000000000000000,-16382.0000000000000000,16384.0000000000000000), 1e-16)
  expect_equal(fit_1d1$En@data[1:5], c(-0.310321165302558821,0.002360175588020617,0.120654554460846580,0.046631935850460847,-0.039907324795865659), 1e-18)
  expect_equal(fit_1d1$S_list_1[[2]][1:5], c(0.347890132216858827,0.003004774389305267,-0.117355149516911908,-0.090272088247716348,0.031177102183022457), 1e-18)
  expect_equal(fit_1d1$S_list_2[[2]][1:5], c(0.197164310915908497,0.114850066904881143,0.000759500660128565,-0.034073644379022147,0.047390267422544874), 1e-18)
  expect_equal(unlist(fit_1d1$norm_list_1), c(0.017814383532596876,0.146626394515064012,0.652468980216661776,0.883229312642957565,0.914771440142973069,0.919015912916133715,0.919638848442015933,0.919736098178892680,0.919751953218482021), 1e-18)
  expect_equal(unlist(fit_1d1$norm_list_2), c(0.336297461564612710,0.659770272669258584,0.878932984916515059,0.912455452829672775,0.917221890915986715,0.917949731464618890,0.918066977673048901,0.918086585522085552), 1e-18)
  expect_equal(fit_1d1$Tsn_list_1[[1]]@data[1:5], c(-0.310321165302558821,0.002360175588020618,0.120654554460846580,0.046631935850460847,-0.039907324795865659), 1e-18)
  expect_equal(fit_1d1$Tsn_list_2[[1]]@data[1:5], c(-0.429282882770205099,0.033568745239126452,0.289272040470669012,-0.299637802285472210,-0.185788720982882349), 1e-18)
  expect_equal(fit_1d1$TsnTsn_list_1[[1]][1:5], c(0.006197448242516960,0.000053528203400009,-0.002090609643019520,-0.001608141602333250,0.000555400855723325), 1e-16)
  expect_equal(fit_1d1$TsnTsn_list_2[[1]][1:5], c(0.0663058572721561,0.0386237859606375,0.0002554181440579,-0.0114588801109205,0.0159372266370700), 1e-16)
  expect_equal(fit_1d1$Sinvhalf_list_1[[1]][1:5], c(38.9998541066681668,6.1298196896407173,-4.2727896795492164,11.5520712181481926,-17.6632249221978945), 1e-16)
  expect_equal(fit_1d1$Sinvhalf_list_2[[1]][1:5], c(13.6981177538128129,2.9713075769618946,2.1039975671290909,-18.9368326256073658,-9.2043591325106817), 1e-16)
  expect_equal(fit_1d1$Sigma[[1]][1:5], c(0.3575493270351964,0.0074535988641281,-0.1087156290990444,-0.0979391945980043,0.0390829818639938), 1e-16)
  expect_equal(fit_1d1$Sigma[[2]][6:10], c(0.0177810223877825,-0.0266821362173798,-0.0159772979718771,-0.0519756927006410,0.0018383691306572), 1e-16)
  expect_equal(fit_1d1$M_list[[1]][1:5], c(0.3288800611837778,0.0068559492778251,-0.0999985178162761,-0.0900861667920602,0.0359492033540018), 1e-16)
  expect_equal(fit_1d1$U_list[[1]][1:5], c(0.0233600851919101,0.0003683074612309,-0.0077124832475057,-0.0070067234516545,0.0022313086456458), 1e-16)
  expect_equal(fit_1d1$W0_list[[1]][[1]][1:5], c(0.0019916035851673,-0.0006808296771030,-0.0009928202065522,-0.0008029470156978,0.0000252780783541), 1e-16)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$nrmX, 1)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$f), -11.0112702876024411)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$g[1:5], c(6.5467815904918139,0.2391295768696464,-2.4984332588195102,-1.9312239505496627,0.6963569808495462), 1e-16)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$dtX)[1:5], c(-6.5388151761511644,-0.2418528955780516,2.4944619779933110,1.9280121624868793,-0.6962558685361299), 1e-16)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$nrmG, 12.0760727114176039, 1e-16)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$XDiff_list[[1]], 0.0003019015976517, 1e-16)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$FDiff_list[[1]]), 0.0015758104839648, 1e-16)
  expect_equal(fit_1d1$test_out_list[[1]][[1]]$Q_list[[1]], 1.8500000000000001, 1e-16)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$Cval_list[[1]]), -11.0215013609240291, 1e-16)
  expect_equal(drop(fit_1d1$test_out_list[[1]][[1]]$X_list[[1]])[1:5], c(0.0006838366483016,-0.0007291981999533,-0.0004939256428093,-0.0004173428036331,-0.0001139729660080), 1e-16)
  expect_equal(fit_1d1$Gamma[[1]][1:5,1], c(0.00014302,-0.00068032,-0.00039628,-0.00031333,-0.00006079))
})

